name: effectful

services:
  # Main Effectful service with two entrypoints
  effectful:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: effectful
    volumes:
      - ..:/app  # Mount source code for development
    environment:
      # PostgreSQL
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_DB: effectful_test
      POSTGRES_USER: effectful
      POSTGRES_PASSWORD: effectful_pass
      DATABASE_URL: postgresql+asyncpg://effectful:effectful_pass@postgres:5432/effectful_test

      # Redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_URL: redis://redis:6379/0

      # MinIO S3
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin
      MINIO_BUCKET: effectful-test
      MINIO_USE_SSL: "false"

      # Pulsar
      PULSAR_URL: pulsar://pulsar:6650
      PULSAR_ADMIN_URL: http://pulsar:8080
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
      pulsar:
        condition: service_healthy
    networks:
      - effectful-network

  # PostgreSQL database
  postgres:
    image: postgres:15-alpine
    container_name: effectful-postgres
    environment:
      POSTGRES_DB: effectful_test
      POSTGRES_USER: effectful
      POSTGRES_PASSWORD: effectful_pass
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=C"
    volumes:
      - effectful-pgdata:/var/lib/postgresql/data  # Named volume (NOT bind mount)
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U effectful -d effectful_test"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - effectful-network

  # Redis cache
  redis:
    image: redis:7-alpine
    container_name: effectful-redis
    command: redis-server --appendonly yes
    volumes:
      - effectful-redisdata:/data  # Named volume for persistence
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - effectful-network

  # MinIO S3-compatible storage
  minio:
    image: minio/minio:latest
    container_name: effectful-minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    volumes:
      - effectful-miniodata:/data  # Named volume for object storage
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - effectful-network

  # Apache Pulsar messaging
  pulsar:
    image: apachepulsar/pulsar:3.1.0
    container_name: effectful-pulsar
    command: >
      bin/pulsar standalone
      --advertised-address pulsar
      --bookkeeper-dir data/standalone/bookkeeper
      -nfw
    environment:
      PULSAR_MEM: "-Xms2048m -Xmx2048m"  # Increased from 512m to 2GB for BookKeeper
      PULSAR_GC: "-XX:MaxDirectMemorySize=1024m"  # Increased from 256m to 1GB
      # BookKeeper single-bookie configuration for standalone mode
      # These settings allow Pulsar to work with only one bookie instance
      PULSAR_STANDALONE_USE_ZOOKEEPER: "1"
      PULSAR_PREFIX_managedLedgerDefaultEnsembleSize: "1"
      PULSAR_PREFIX_managedLedgerDefaultWriteQuorum: "1"
      PULSAR_PREFIX_managedLedgerDefaultAckQuorum: "1"
    volumes:
      - effectful-pulsardata:/pulsar/data  # Named volume for message persistence
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/admin/v2/brokers"]
      interval: 10s
      timeout: 5s
      retries: 30  # Pulsar takes longer to initialize
    networks:
      - effectful-network

  # Prometheus metrics server
  prometheus:
    image: prom/prometheus:latest
    container_name: effectful-prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=15d'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./prometheus/alerts.yml:/etc/prometheus/alerts.yml:ro
      - effectful-prometheusdata:/prometheus  # Named volume for metrics data
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:9090/-/healthy"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - effectful-network

  # Grafana dashboards
  grafana:
    image: grafana/grafana:latest
    container_name: effectful-grafana
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin
      GF_USERS_ALLOW_SIGN_UP: "false"
      GF_INSTALL_PLUGINS: ""
    volumes:
      - ./grafana/datasources:/etc/grafana/provisioning/datasources:ro
      - ./grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
      - effectful-grafanadata:/var/lib/grafana  # Named volume for dashboard data
    depends_on:
      prometheus:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - effectful-network

# Named volumes for data persistence
# CRITICAL: Use named volumes, NOT bind mounts on macOS (see CLAUDE.md Anti-Pattern #21)
volumes:
  effectful-pgdata:
    driver: local
  effectful-redisdata:
    driver: local
  effectful-miniodata:
    driver: local
  effectful-pulsardata:
    driver: local
  effectful-prometheusdata:
    driver: local
  effectful-grafanadata:
    driver: local

networks:
  effectful-network:
    driver: bridge
