# Code Organization Doctrine

**Status**: Authoritative source
**Supersedes**: none
**Referenced by**: CLAUDE.md, architecture.md, README.md, docker_workflow.md

> **Purpose**: Defines the canonical directory structure for multi-language codebases, ensuring consistent organization across all source code regardless of programming language.

______________________________________________________________________

## Doctrine: src/\<language>/ Structure

All source code MUST reside in `src/<language>/` directories organized by programming language:

```text
project-root/
├── src/
│   ├── python/           # Python packages
│   ├── haskell/          # Haskell modules
│   ├── rust/             # Rust crates
│   └── typescript/       # TypeScript source
├── tests/                # Test suites (stays at root)
├── documents/            # Documentation (stays at root)
├── docker/               # Infrastructure (stays at root)
└── examples/             # Example scripts (stays at root)
```

### Language Directories

| Directory         | Purpose                                      | Build Tool  |
| ----------------- | -------------------------------------------- | ----------- |
| `src/python/`     | Python packages (effectful, effectful_tools) | Poetry      |
| `src/haskell/`    | Haskell modules for thunk generation         | Cabal/Stack |
| `src/rust/`       | Rust crates for performance-critical paths   | Cargo       |
| `src/typescript/` | TypeScript for frontend applications         | npm/pnpm    |

______________________________________________________________________

## Rationale

### Clear Language Separation

Each language has distinct:

- Build systems (Poetry vs Cargo vs Cabal)
- Dependency management (pyproject.toml vs Cargo.toml vs .cabal)
- Compilation targets
- IDE configuration

Separating by language prevents configuration conflicts and enables language-specific tooling.

### Cross-Language Compilation Pipeline

**Future Architecture**: The Python effect interpreter will ingest thunks generated by Haskell:

```text
src/haskell/       →  Compile  →  Thunks
        ↓
src/python/effectful/  ←  Import  ←  Thunks
        ↓
Runtime execution
```

This organization enables:

- Independent compilation of Haskell modules
- Generated artifact handoff to Python
- Clear dependency direction

### Consistent Toolchain Configuration

Each `src/<language>/` directory can have its own:

- Lock files (poetry.lock, Cargo.lock, package-lock.json)
- Configuration files (pyproject.toml, Cargo.toml, tsconfig.json)
- Build scripts specific to that language

______________________________________________________________________

## Demo Applications

Demo projects follow the same organizational pattern:

```text
demo/healthhub/
├── src/
│   ├── python/           # Backend application
│   │   ├── app/          # FastAPI application
│   │   └── scripts/      # Database scripts
│   └── typescript/       # Frontend application
│       ├── src/          # React components
│       └── tests/        # Vitest tests
├── tests/                # Integration tests
├── documents/            # Demo-specific docs
└── docker/               # Demo infrastructure
```

### Import Paths After Reorganization

**Core Library**:

```python
# pyproject.toml
packages = [
    {include = "effectful", from = "src/python"},
    {include = "effectful_tools", from = "src/python"},
]
```

**Docker PYTHONPATH**:

```dockerfile
ENV PYTHONPATH="/app/src/python:/app"
```

______________________________________________________________________

## Exceptions

The following directories remain at project root:

| Directory    | Reason                                   |
| ------------ | ---------------------------------------- |
| `tests/`     | pytest discovery expects tests at root   |
| `documents/` | Documentation is language-agnostic       |
| `examples/`  | Example scripts demonstrate usage        |
| `docker/`    | Infrastructure configuration is separate |
| `configs/`   | Application configuration files          |
| `stubs/`     | Type stubs for external libraries        |

______________________________________________________________________

## Migration Guide

When reorganizing an existing codebase:

1. **Create directory structure**:

   ```bash
   # create structure
   mkdir -p src/python src/haskell src/rust
   ```

1. **Move packages with git mv** (preserves history):

   ```bash
   # move packages
   git mv effectful src/python/effectful
   git mv effectful_tools src/python/effectful_tools
   ```

1. **Update pyproject.toml**:

   ```toml
   # pyproject.toml packages section
   packages = [
       {include = "effectful", from = "src/python"},
       {include = "effectful_tools", from = "src/python"},
   ]
   ```

1. **Update Docker configuration**:

   - PYTHONPATH environment variables
   - Volume mounts
   - COPY commands in Dockerfile

1. **Update documentation paths**:

   - CLAUDE.md references
   - Architecture documentation
   - Tutorial examples

______________________________________________________________________

## Cross-References

- [Architecture](architecture.md) - 5-layer architecture design
- [Docker Workflow](docker_workflow.md) - Container-based development
- [Code Quality](code_quality.md) - Type safety standards
- [CLAUDE.md](../../CLAUDE.md) - Project overview
