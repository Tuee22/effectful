# Build Artifact Management (HealthHub Overlay)

**Status**: Demo overlay (delta-only)
**Base**: [Effectful build_artifact_management.md](../../../../documents/engineering/build_artifact_management.md)
**Referenced by**: [docker.md](docker.md), [docker_workflow.md](../../../../documents/engineering/docker_workflow.md), [README.md](README.md), [CLAUDE.md](../../CLAUDE.md)

> **Pattern**: This document contains ONLY HealthHub-specific deltas. For shared patterns, see base effectful documentation.

---

## HealthHub-Specific Build Artifacts

**Base patterns**: See [effectful build_artifact_management.md](../../../../documents/engineering/build_artifact_management.md) for shared cache placement, lock guard, and regeneration patterns.

### Frontend Build Artifacts

**Critical addition**: HealthHub generates frontend build artifacts (`/opt/healthhub/frontend-build/build/`) during Docker image build.

#### Frontend Build Output

**Location**: `/opt/healthhub/frontend-build/build/`

**Contents**:

- `index.html` - React app entry point
- `assets/` - JavaScript bundles, CSS, fonts, images
- `vite.config.ts.timestamp-*.mjs` - Vite metadata files

**Generated by**: `npm run build` (vite build) during Dockerfile step

**Verification**: Dockerfile includes `ls -la build/index.html` to ensure build succeeded

**Why in `/opt/healthhub/`?**

- Follows ShipNorth production-hardened pattern for namespaced artifacts
- Clear ownership (HealthHub-specific, not shared with effectful)
- Prevents conflicts during integration validation (Phase 6)

#### Frontend Lock File Pattern

**Pattern**: Lock file (`package-lock.json`) regenerated in-container, NEVER committed to repository.

**Rationale**:

- Lock files are build artifacts, not source code
- npm version in container may differ from host (deterministic builds)
- Prevents cross-platform lock file conflicts (macOS host, Linux container)

**Build process**:

1. Copy `package.json` to `/opt/healthhub/frontend-build/`
2. Run `npm install --quiet` (generates fresh `package-lock.json`)
3. Run `npm run build` (uses freshly generated lock file)

**See also**: [Frontend Build Management](docker.md#frontend-build-management) for complete frontend build workflow.

---

## Cache Placement Contract (HealthHub-Specific)

**Base contract**: See [effectful build_artifact_management.md](../../../../documents/engineering/build_artifact_management.md#cache-placement-contract) for shared cache patterns.

### HealthHub Cache Namespace

**HealthHub Namespace** (`/opt/healthhub/`):

- `MYPY_CACHE_DIR=/opt/healthhub/mypy_cache` - MyPy type checker cache
- `PYTEST_CACHE_DIR=/opt/healthhub/pytest_cache` - Pytest cache
- `RUFF_CACHE_DIR=/opt/healthhub/ruff_cache` - Ruff linter cache
- `XDG_CACHE_HOME=/opt/healthhub/cache` - General tool cache
- `PYTHONPYCACHEPREFIX=/opt/healthhub/pycache` - Python bytecode cache (HealthHub-specific)

**Why separate from effectful**:

- Prevents cache conflicts when both containers run simultaneously
- HealthHub imports both effectful AND backend modules (different PYTHONPATH)
- Different bytecode cache requirements due to dual dependencies

**Configuration**: Environment variables set in `docker/Dockerfile` (SSoT policy)

**ðŸ“– See**: [docker.md - Environment Variables](docker.md#environment-variables-healthhub-specific) for complete HealthHub cache directory documentation.

---

## Lock Guard Pattern (HealthHub-Specific)

**Base pattern**: See [effectful build_artifact_management.md](../../../../documents/engineering/build_artifact_management.md#lock-guard-pattern) for shared lock guard rationale.

### Backend Dependencies Lock Guard

HealthHub uses an **enhanced** lock guard with fallback to direct pip install:

```dockerfile
RUN poetry lock --no-update 2>/dev/null || true && \
    poetry install --with dev --no-root --no-interaction --no-ansi 2>/dev/null || \
    pip install \
    fastapi "uvicorn[standard]" "pydantic[email]" pydantic-settings \
    asyncpg redis pulsar-client bcrypt pyjwt python-multipart \
    "python-jose[cryptography]" "passlib[bcrypt]" boto3 prometheus-client \
    email-validator pytest pytest-asyncio pytest-cov pytest-mock pytest-timeout httpx \
    mypy black ruff mdformat mdformat-gfm mdformat-frontmatter mdformat-footnote mdformat-tables \
    pymarkdownlnt codespell playwright pytest-playwright
```

**Why fallback to pip?**

- HealthHub depends on effectful as local path dependency (`../../`)
- Poetry resolver may fail if effectful structure changes
- Fallback ensures build succeeds even if Poetry lock fails
- Production-hardened pattern from ShipNorth

**Trade-off**:

- Poetry preferred (lock file provides deterministic dependencies)
- Pip fallback sacrifices determinism for resilience
- Acceptable for demo application (HealthHub), NOT for production effectful library

---

## Build Artifact Lifecycle

**Base lifecycle**: See [effectful build_artifact_management.md](../../../../documents/engineering/build_artifact_management.md#build-artifact-lifecycle) for shared patterns.

### HealthHub-Specific Artifacts

| Artifact                   | Generated By     | Location                                  | Lifecycle                        |
| -------------------------- | ---------------- | ----------------------------------------- | -------------------------------- |
| Frontend build output      | vite build       | `/opt/healthhub/frontend-build/build/`    | Docker image (container-only)    |
| Frontend lock file         | npm install      | `/opt/healthhub/frontend-build/`          | Docker build (ephemeral)         |
| Backend lock file          | poetry lock      | `/app/effectful-root/demo/healthhub/`     | Docker build (ephemeral)         |
| MyPy cache                 | mypy             | `/opt/healthhub/mypy_cache/`              | Container runtime (not bindmount |
| Pytest cache               | pytest           | `/opt/healthhub/pytest_cache/`            | Container runtime (not bindmount |
| Ruff cache                 | ruff             | `/opt/healthhub/ruff_cache/`              | Container runtime (not bindmount |
| Python bytecode cache      | Python runtime   | `/opt/healthhub/pycache/`                 | Container runtime (not bindmount |
| Playwright browser binaries | playwright install | `/root/.cache/ms-playwright/`           | Docker image (container-only)    |

**Critical**: Frontend build output baked into Docker image, NOT volume-mounted back to host.

---

## SSoT Link Map

| Topic                                 | SSoT                                                                                                   |
| ------------------------------------- | ------------------------------------------------------------------------------------------------------ |
| Build artifact management (shared)    | [Effectful build_artifact_management.md](../../../../documents/engineering/build_artifact_management.md) |
| Cache placement contract (shared)     | [Effectful build_artifact_management.md](../../../../documents/engineering/build_artifact_management.md#cache-placement-contract) |
| Lock guard pattern (shared)           | [Effectful build_artifact_management.md](../../../../documents/engineering/build_artifact_management.md#lock-guard-pattern) |
| Frontend build artifacts              | This document                                                                                          |
| Frontend lock file pattern            | This document                                                                                          |
| HealthHub cache namespace             | This document                                                                                          |
| Backend dependencies lock guard       | This document                                                                                          |
| Build artifact lifecycle (HealthHub)  | This document                                                                                          |
| Environment variables                 | [docker.md](docker.md#environment-variables-healthhub-specific)                                       |
| Frontend build management             | [docker.md](docker.md#frontend-build-management)                                                      |
| Docker workflow                       | [docker_workflow.md](../../../../documents/engineering/docker_workflow.md)                            |
| Testing                               | [testing.md](../../../../documents/engineering/testing.md)                                            |
| Command reference                     | [command_reference.md](../../../../documents/engineering/command_reference.md)                        |
| Development workflow                  | [development_workflow.md](../../../../documents/engineering/development_workflow.md)                  |
| Architecture                          | [architecture.md](../../../../documents/engineering/architecture.md)                                  |
| Code quality                          | [code_quality.md](../../../../documents/engineering/code_quality.md)                                  |
| HealthHub overview                    | [CLAUDE.md](../../CLAUDE.md)                                                                          |
| Engineering standards index           | [Engineering README](../../../../documents/engineering/README.md)                                     |
