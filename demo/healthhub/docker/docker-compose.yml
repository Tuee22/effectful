name: healthhub

services:
  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    container_name: healthhub_postgres
    environment:
      POSTGRES_USER: healthhub
      POSTGRES_PASSWORD: healthhub_secure_pass
      POSTGRES_DB: healthhub_db
    volumes:
      - healthhub_pgdata:/var/lib/postgresql/data
      - ../backend/scripts/init_db.sql:/docker-entrypoint-initdb.d/01-init.sql
      - ../backend/scripts/seed_data.sql:/docker-entrypoint-initdb.d/02-seed.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U healthhub -d healthhub_db"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - healthhub-network

  # Redis for Cache and Pub/Sub
  redis:
    image: redis:7-alpine
    container_name: healthhub_redis
    volumes:
      - healthhub_redisdata:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - healthhub-network

  # Apache Pulsar for Durable Messaging
  pulsar:
    image: apachepulsar/pulsar:3.0.0
    container_name: healthhub_pulsar
    command: bin/pulsar standalone
    volumes:
      - healthhub_pulsardata:/pulsar/data
    environment:
      PULSAR_MEM: "-Xms512m -Xmx512m"
    healthcheck:
      test: ["CMD", "bin/pulsar-admin", "brokers", "healthcheck"]
      interval: 10s
      timeout: 10s
      retries: 5
    networks:
      - healthhub-network

  # MinIO S3-compatible Storage
  minio:
    image: minio/minio:latest
    container_name: healthhub_minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: healthhub_minio
      MINIO_ROOT_PASSWORD: healthhub_minio_secret
    volumes:
      - healthhub_miniodata:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 10s
      timeout: 10s
      retries: 5
    networks:
      - healthhub-network

  # HealthHub Backend Service
  healthhub:
    build:
      context: ../../..  # effectful root directory
      dockerfile: demo/healthhub/docker/Dockerfile
    container_name: healthhub_backend
    ports:
      - "8851:8851"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
    environment:
      # Effectful + Healthhub Python paths
      PYTHONPATH: /app/effectful-root:/app/healthhub:/app/healthhub/backend

      # Database
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_DB: healthhub_db
      POSTGRES_USER: healthhub
      POSTGRES_PASSWORD: healthhub_secure_pass

      # Redis
      REDIS_HOST: redis
      REDIS_PORT: 6379

      # Pulsar
      PULSAR_URL: pulsar://pulsar:6650
      PULSAR_ADMIN_URL: http://pulsar:8080

      # MinIO S3
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: healthhub_minio
      MINIO_SECRET_KEY: healthhub_minio_secret
      MINIO_BUCKET: healthhub-medical-docs

      # Application
      APP_ENV: development
      LOG_LEVEL: INFO

      # JWT Settings
      JWT_SECRET_KEY: healthhub_jwt_secret_key_change_in_production
      JWT_ALGORITHM: HS256
      JWT_ACCESS_TOKEN_EXPIRE_MINUTES: 15
      JWT_REFRESH_TOKEN_EXPIRE_DAYS: 7

      # E2E Testing
      E2E_BACKEND_URL: http://localhost:8851
      DESTRUCTIVELY_SEED_DB_TEST_DATA: "true"
    volumes:
      # Mount effectful library read-only for hot reload
      - ../../../effectful:/app/effectful-root/effectful:ro
      # Mount healthhub backend for hot reload
      - ../backend/app:/app/healthhub/backend/app
      - ../backend/scripts:/app/healthhub/backend/scripts
      - ../tools:/app/healthhub/tools
      - ../tests:/app/healthhub/tests
    command: uvicorn backend.app.main:app --host 0.0.0.0 --port 8851 --reload
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8851/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - healthhub-network

volumes:
  healthhub_pgdata:
  healthhub_redisdata:
  healthhub_pulsardata:
  healthhub_miniodata:

networks:
  healthhub-network:
    driver: bridge
